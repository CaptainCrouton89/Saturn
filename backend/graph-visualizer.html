<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Graph Visualizer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f1419;
            color: #e7e9ea;
            overflow: hidden;
        }

        #graph {
            width: 100vw;
            height: 100vh;
        }

        .node {
            cursor: pointer;
            stroke: #1d9bf0;
            stroke-width: 2px;
        }

        .node-label {
            font-size: 12px;
            fill: #e7e9ea;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: middle;
        }

        .link {
            stroke: #536471;
            stroke-width: 1.5px;
            stroke-opacity: 0.6;
            cursor: pointer;
        }

        .link:hover {
            stroke: #1d9bf0;
            stroke-width: 3px;
            stroke-opacity: 1;
        }

        .link-hitbox {
            stroke: transparent;
            stroke-width: 20px;
            cursor: pointer;
        }

        .link-label {
            font-size: 10px;
            fill: #71767b;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: middle;
        }

        #details-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 350px;
            max-height: 80vh;
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 12px;
            padding: 20px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        #details-panel.visible {
            display: block;
        }

        #details-panel h2 {
            color: #1d9bf0;
            margin-bottom: 12px;
            font-size: 18px;
        }

        #details-panel .section {
            margin-bottom: 16px;
        }

        #details-panel .label {
            color: #71767b;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        #details-panel .value {
            color: #e7e9ea;
            font-size: 14px;
            line-height: 1.5;
        }

        #details-panel .close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #71767b;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            line-height: 24px;
        }

        #details-panel .close:hover {
            color: #e7e9ea;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 12px;
            padding: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid #1d9bf0;
        }

        .legend-label {
            font-size: 13px;
            color: #e7e9ea;
        }

        .controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #16181c;
            border: 1px solid #2f3336;
            border-radius: 12px;
            padding: 16px;
        }

        .controls button {
            background: #1d9bf0;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .controls button:hover {
            background: #1a8cd8;
        }
    </style>
</head>
<body>
    <div id="graph"></div>

    <div class="controls">
        <button onclick="resetZoom()">Reset Zoom</button>
        <button onclick="toggleLabels()">Toggle Labels</button>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #1d9bf0;"></div>
            <span class="legend-label">Source</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #00ba7c;"></div>
            <span class="legend-label">Concept</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ffd400;"></div>
            <span class="legend-label">Entity</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f91880;"></div>
            <span class="legend-label">Person</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ff6b6b;"></div>
            <span class="legend-label">Artifact</span>
        </div>
    </div>

    <div id="details-panel">
        <button class="close" onclick="closeDetails()">×</button>
        <div id="details-content"></div>
    </div>

    <script>
        // Neo4j connection config (hardcoded for local development)
        const NEO4J_CONFIG = {
            uri: 'http://localhost:7474',
            database: 'neo4j',
            username: 'neo4j',
            password: 'your_password_here'
        };

        // Fetch graph data from Neo4j
        async function fetchGraphData() {
            const query = `
                MATCH (n)
                OPTIONAL MATCH (n)-[r]->(m)
                RETURN
                    collect(DISTINCT {
                        entity_key: n.entity_key,
                        type: labels(n)[0],
                        properties: properties(n)
                    }) as nodes,
                    collect({
                        from_entity_key: n.entity_key,
                        to_entity_key: m.entity_key,
                        type: type(r),
                        properties: properties(r)
                    }) as relationships
            `;

            const response = await fetch(`${NEO4J_CONFIG.uri}/db/${NEO4J_CONFIG.database}/tx/commit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Basic ' + btoa(`${NEO4J_CONFIG.username}:${NEO4J_CONFIG.password}`)
                },
                body: JSON.stringify({
                    statements: [{
                        statement: query
                    }]
                })
            });

            const result = await response.json();

            if (result.errors && result.errors.length > 0) {
                throw new Error(result.errors[0].message);
            }

            // Neo4j HTTP API returns: results[0].data[0].row = [nodes, relationships]
            const row = result.results[0].data[0].row;
            const nodes = row[0];
            const relationships = row[1];

            // Filter out null relationships (from nodes with no outgoing edges)
            const validRelationships = relationships.filter(r =>
                r && r.from_entity_key && r.to_entity_key && r.type
            );

            return {
                nodes: nodes,
                relationships: validRelationships
            };
        }

        // Initialize visualization with fetched data
        let graphData;
        fetchGraphData()
            .then(data => {
                graphData = data;
                initializeVisualization();
            })
            .catch(error => {
                console.error('Error fetching graph data:', error);
                document.body.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; color: #e7e9ea; font-size: 16px;">
                        <div>
                            <h2 style="color: #f91880; margin-bottom: 16px;">Failed to load graph data</h2>
                            <p>${error.message}</p>
                            <p style="margin-top: 16px; color: #71767b;">Check that Neo4j is running at ${NEO4J_CONFIG.uri}</p>
                        </div>
                    </div>
                `;
            });

        function initializeVisualization() {
            if (!graphData || !graphData.nodes || graphData.nodes.length === 0) {
                document.body.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; color: #e7e9ea; font-size: 16px;">
                        <div style="text-align: center;">
                            <h2 style="color: #1d9bf0; margin-bottom: 16px;">No data in graph</h2>
                            <p>The Neo4j database is empty. Run the ingestion pipeline to populate it.</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Set up dimensions
            const width = window.innerWidth;
            const height = window.innerHeight;

            // Color mapping for node types (explicit mapping)
            const colorMap = {
                'Source': '#1d9bf0',    // blue
                'Concept': '#00ba7c',   // green
                'Entity': '#ffd400',    // yellow
                'Person': '#f91880',    // magenta
                'Artifact': '#ff6b6b'   // red/orange
            };
            const nodeTypes = [...new Set(graphData.nodes.map(n => n.type))];

            // Create SVG
            const svg = d3.select('#graph')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Add zoom behavior
            const g = svg.append('g');
            const zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });
            svg.call(zoom);

            // Transform data for D3
            const nodes = graphData.nodes.map(n => ({
                id: n.entity_key,
                type: n.type,
                ...n.properties
            }));

            const links = graphData.relationships.map(r => ({
                source: r.from_entity_key,
                target: r.to_entity_key,
                type: r.type,
                ...r.properties
            }));

            // Create force simulation
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(150))
                .force('charge', d3.forceManyBody().strength(-400))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(60));

            // Create links
            const link = g.append('g')
                .selectAll('line')
                .data(links)
                .join('line')
                .attr('class', 'link');

            // Create invisible hitbox for easier clicking
            const linkHitbox = g.append('g')
                .selectAll('line')
                .data(links)
                .join('line')
                .attr('class', 'link-hitbox')
                .on('click', showEdgeDetails);

            // Create link labels
            const linkLabel = g.append('g')
                .selectAll('text')
                .data(links)
                .join('text')
                .attr('class', 'link-label')
                .text(d => d.type.replace(/_/g, ' '));

            // Create nodes
            const node = g.append('g')
                .selectAll('circle')
                .data(nodes)
                .join('circle')
                .attr('class', 'node')
                .attr('r', 20)
                .attr('fill', d => colorMap[d.type] || '#71767b')
                .on('click', showDetails)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // Create node labels
            const nodeLabel = g.append('g')
                .selectAll('text')
                .data(nodes)
                .join('text')
                .attr('class', 'node-label')
                .attr('dy', 35)
                .text(d => d.name || d.type);

            // Update positions on simulation tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                linkHitbox
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                linkLabel
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);

                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);

                nodeLabel
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });

            // Drag functions
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            // Show node details
            function showDetails(event, d) {
                const panel = document.getElementById('details-panel');
                const content = document.getElementById('details-content');

                let html = `<h2>${d.name || d.type}</h2>`;

                html += `<div class="section">
                    <div class="label">Type</div>
                    <div class="value">${d.type}</div>
                </div>`;

                if (d.description) {
                    html += `<div class="section">
                        <div class="label">Description</div>
                        <div class="value">${d.description}</div>
                    </div>`;
                }

                if (d.content) {
                    let contentObj;
                    try {
                        contentObj = typeof d.content === 'string' ? JSON.parse(d.content) : d.content;
                    } catch (e) {
                        contentObj = { content: d.content };
                    }

                    if (contentObj && contentObj.content) {
                        html += `<div class="section">
                            <div class="label">Conversation Content</div>
                            <div class="value" style="max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-size: 12px; line-height: 1.4;">
                                ${contentObj.content}
                            </div>
                        </div>`;
                    }
                }

                if (d.notes) {
                    // Parse notes if it's a JSON string
                    let notesArray;
                    try {
                        notesArray = typeof d.notes === 'string' ? JSON.parse(d.notes) : d.notes;
                    } catch (e) {
                        notesArray = [{ content: d.notes }];
                    }

                    if (notesArray && notesArray.length > 0) {
                        html += `<div class="section">
                            <div class="label">Notes (${notesArray.length})</div>
                            <div class="value">`;
                        notesArray.forEach((note, idx) => {
                            const dateAdded = note.date_added
                                ? new Date(note.date_added).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
                                : '';

                            let expiresDisplay;
                            if (!note.expires_at || note.expires_at === null) {
                                expiresDisplay = 'Forever';
                            } else {
                                expiresDisplay = new Date(note.expires_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                            }

                            html += `<div style="margin-bottom: 12px; padding: 8px; background: #1a1d23; border-radius: 6px;">
                                ${note.content}
                                <div style="margin-top: 6px; font-size: 11px; color: #71767b;">
                                    ${dateAdded ? `Added: ${dateAdded}` : ''}
                                    ${dateAdded ? ' • ' : ''}
                                    Expires: ${expiresDisplay}
                                </div>
                            </div>`;
                        });
                        html += `</div></div>`;
                    }
                }

                if (d.confidence !== undefined) {
                    html += `<div class="section">
                        <div class="label">Confidence</div>
                        <div class="value">${(d.confidence * 100).toFixed(0)}%</div>
                    </div>`;
                }

                if (d.last_update_source) {
                    html += `<div class="section">
                        <div class="label">Last Update Source</div>
                        <div class="value">${d.last_update_source}</div>
                    </div>`;
                }

                // Show connected relationships
                const outgoing = links.filter(l => l.source.id === d.id);
                const incoming = links.filter(l => l.target.id === d.id);

                if (outgoing.length > 0) {
                    html += `<div class="section">
                        <div class="label">Outgoing Relationships</div>
                        <div class="value">`;
                    outgoing.forEach(l => {
                        const target = nodes.find(n => n.id === l.target.id);
                        html += `<div>→ ${l.type.replace(/_/g, ' ')} → ${target.name || target.type}</div>`;
                    });
                    html += `</div></div>`;
                }

                if (incoming.length > 0) {
                    html += `<div class="section">
                        <div class="label">Incoming Relationships</div>
                        <div class="value">`;
                    incoming.forEach(l => {
                        const source = nodes.find(n => n.id === l.source.id);
                        html += `<div>← ${l.type.replace(/_/g, ' ')} ← ${source.name || source.type}</div>`;
                    });
                    html += `</div></div>`;
                }

                content.innerHTML = html;
                panel.classList.add('visible');
            }

            // Show edge details
            function showEdgeDetails(event, d) {
                event.stopPropagation();
                const panel = document.getElementById('details-panel');
                const content = document.getElementById('details-content');

                const sourceName = d.source.name || d.source.type;
                const targetName = d.target.name || d.target.type;

                let html = `<h2>${d.type.replace(/_/g, ' ')}</h2>`;

                html += `<div class="section">
                    <div class="label">Relationship Type</div>
                    <div class="value">${d.type}</div>
                </div>`;

                html += `<div class="section">
                    <div class="label">From</div>
                    <div class="value">${sourceName}</div>
                </div>`;

                html += `<div class="section">
                    <div class="label">To</div>
                    <div class="value">${targetName}</div>
                </div>`;

                // Show all edge properties except 'type'
                const edgeProps = Object.keys(d).filter(key =>
                    !['source', 'target', 'type', 'index', 'x', 'y', 'vx', 'vy', 'notes'].includes(key)
                );

                if (edgeProps.length > 0) {
                    html += `<div class="section">
                        <div class="label">Properties</div>
                        <div class="value">`;
                    edgeProps.forEach(prop => {
                        const value = d[prop];
                        if (value !== undefined && value !== null) {
                            const displayKey = prop.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                            html += `<div style="margin-bottom: 8px;">
                                <strong style="color: #1d9bf0;">${displayKey}:</strong><br/>
                                ${value}
                            </div>`;
                        }
                    });
                    html += `</div></div>`;
                }

                // Handle notes separately for relationships
                if (d.notes) {
                    let notesArray;
                    try {
                        notesArray = typeof d.notes === 'string' ? JSON.parse(d.notes) : d.notes;
                    } catch (e) {
                        notesArray = [{ content: d.notes }];
                    }

                    if (notesArray && notesArray.length > 0) {
                        html += `<div class="section">
                            <div class="label">Notes (${notesArray.length})</div>
                            <div class="value">`;
                        notesArray.forEach((note, idx) => {
                            const dateAdded = note.date_added
                                ? new Date(note.date_added).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
                                : '';

                            let expiresDisplay;
                            if (!note.expires_at || note.expires_at === null) {
                                expiresDisplay = 'Forever';
                            } else {
                                expiresDisplay = new Date(note.expires_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                            }

                            html += `<div style="margin-bottom: 12px; padding: 8px; background: #1a1d23; border-radius: 6px;">
                                ${note.content}
                                <div style="margin-top: 6px; font-size: 11px; color: #71767b;">
                                    ${dateAdded ? `Added: ${dateAdded}` : ''}
                                    ${dateAdded ? ' • ' : ''}
                                    Expires: ${expiresDisplay}
                                </div>
                            </div>`;
                        });
                        html += `</div></div>`;
                    }
                }

                content.innerHTML = html;
                panel.classList.add('visible');
            }

            let labelsVisible = true;

            // Handle window resize
            window.addEventListener('resize', () => {
                const newWidth = window.innerWidth;
                const newHeight = window.innerHeight;
                svg.attr('width', newWidth).attr('height', newHeight);
                simulation.force('center', d3.forceCenter(newWidth / 2, newHeight / 2));
                simulation.alpha(0.3).restart();
            });

            // Update legend with actual node types
            const legend = document.querySelector('.legend');
            legend.innerHTML = nodeTypes.map(type => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${colorMap[type]};"></div>
                    <span class="legend-label">${type}</span>
                </div>
            `).join('');

            // Make these functions available globally for button onclick handlers
            window.resetZoom = function() {
                svg.transition()
                    .duration(750)
                    .call(zoom.transform, d3.zoomIdentity);
            };

            window.toggleLabels = function() {
                labelsVisible = !labelsVisible;
                nodeLabel.style('display', labelsVisible ? 'block' : 'none');
                linkLabel.style('display', labelsVisible ? 'block' : 'none');
            };

            window.closeDetails = function() {
                document.getElementById('details-panel').classList.remove('visible');
            };
        }
    </script>
</body>
</html>
